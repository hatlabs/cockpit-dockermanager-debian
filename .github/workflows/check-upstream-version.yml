name: Check Upstream Version

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 06:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Query GitHub API for latest release
        id: upstream-version
        run: |
          echo "Querying GitHub API for latest cockpit-dockermanager release..."
          LATEST_TAG=$(curl -s "https://api.github.com/repos/chrisjbawden/cockpit-dockermanager/releases/latest" \
            | jq -r '.tag_name // empty')

          if [ -z "$LATEST_TAG" ]; then
            echo "Error: Failed to fetch version from GitHub API"
            exit 1
          fi

          # Strip 'v' prefix for VERSION file (e.g., v1.0.7 -> 1.0.7)
          LATEST_VERSION=${LATEST_TAG#v}

          echo "Latest upstream tag: $LATEST_TAG"
          echo "Latest version (for VERSION file): $LATEST_VERSION"
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Read current VERSION file
        id: current-version
        run: |
          if [ -f VERSION ]; then
            CURRENT_VERSION=$(cat VERSION | tr -d '[:space:]')
            echo "Current tracked version: $CURRENT_VERSION"
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "VERSION file not found, will create it"
            echo "version=" >> $GITHUB_OUTPUT
          fi

      - name: Compare versions
        id: compare
        run: |
          LATEST="${{ steps.upstream-version.outputs.version }}"
          CURRENT="${{ steps.current-version.outputs.version }}"

          if [ -z "$CURRENT" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "VERSION file missing, needs creation"
          elif [ "$LATEST" = "$CURRENT" ]; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Versions match, no update needed"
          else
            # Simple version comparison (works for most semver)
            if [ "$(printf '%s\n' "$LATEST" "$CURRENT" | sort -V | tail -n1)" = "$LATEST" ] && [ "$LATEST" != "$CURRENT" ]; then
              echo "needs_update=true" >> $GITHUB_OUTPUT
              echo "New version available: $LATEST > $CURRENT"
            else
              echo "needs_update=false" >> $GITHUB_OUTPUT
              echo "Current version is up to date or newer"
            fi
          fi

      - name: Create Pull Request
        if: steps.compare.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST_VERSION="${{ steps.upstream-version.outputs.version }}"
          BRANCH_NAME="update-cockpit-dockermanager-${LATEST_VERSION//[:+~.]/-}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create new branch
          git checkout -b "$BRANCH_NAME"

          # Update VERSION file
          echo "$LATEST_VERSION" > VERSION
          git add VERSION

          # Commit changes
          git commit -m "chore: update cockpit-dockermanager to $LATEST_VERSION"

          # Push branch
          git push origin "$BRANCH_NAME"

          LATEST_TAG="${{ steps.upstream-version.outputs.tag }}"

          # Create PR
          gh pr create \
            --title "chore: update cockpit-dockermanager to $LATEST_VERSION" \
            --body "$(cat <<EOF
          ## Cockpit Docker Manager Version Update

          This PR updates the cockpit-dockermanager package version to track the latest release from the upstream repository.

          **New Version:** \`$LATEST_VERSION\`
          **Previous Version:** \`${{ steps.current-version.outputs.version }}\`

          ### Details

          - **Upstream Repository:** [chrisjbawden/cockpit-dockermanager](https://github.com/chrisjbawden/cockpit-dockermanager)
          - **Release Page:** [$LATEST_TAG](https://github.com/chrisjbawden/cockpit-dockermanager/releases/tag/$LATEST_TAG)

          ### What happens after merge?

          1. Update \`debian/changelog\` with the new version
          2. Build and test the Debian package
          3. Tag and release if build succeeds

          ### Testing

          To test this version locally:

          \`\`\`bash
          # Checkout this branch
          git fetch origin $BRANCH_NAME
          git checkout $BRANCH_NAME

          # Clone upstream at new version
          ./run setup:clone
          cd cockpit-dockermanager
          git checkout $LATEST_TAG
          cd ..

          # Build package
          ./run package:deb:docker

          # Test installation
          sudo dpkg -i cockpit-dockermanager_${LATEST_VERSION}-1_all.deb
          \`\`\`

          Please verify:
          - [ ] VERSION file is correctly updated
          - [ ] Upstream release notes reviewed
          - [ ] Package builds successfully
          - [ ] Package installs and works correctly

          ---
          ðŸ¤– This PR was automatically created by the upstream version check workflow.
          EOF
          )" \
            --base main \
            --head "$BRANCH_NAME"
