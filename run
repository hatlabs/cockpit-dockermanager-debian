#!/usr/bin/env bash
#
# usage: ./run command [argument ...]
#
# Commands used during development / CI.
#

set -o nounset
set -o pipefail
set -o errexit

# Change the current directory to the project root.
PROJECT_ROOT=${0%/*}
if [[ $0 != $PROJECT_ROOT && $PROJECT_ROOT != "" ]]; then
  cd "$PROJECT_ROOT"
fi
readonly PROJECT_ROOT=$(pwd)

# Store the absolute path to this script (useful for recursion).
readonly SCRIPT="$PROJECT_ROOT/$(basename "$0")"

################################################################################
# Core Commands

function release:version {
  #@ Show current project version
  #@ Category: Core
  cat VERSION
}

################################################################################
# Setup Commands

function setup:clone {
  #@ Clone upstream cockpit-dockermanager repository
  #@ Category: Setup
  if [ -d "cockpit-dockermanager" ]; then
    echo "‚ö†Ô∏è  cockpit-dockermanager directory already exists"
    echo "   Use setup:pull to update or remove it first"
    return 1
  fi

  echo "üì• Cloning cockpit-dockermanager..."
  git clone https://github.com/chrisjbawden/cockpit-dockermanager.git
  echo "‚úÖ Upstream repository cloned"
}

function setup:pull {
  #@ Update upstream cockpit-dockermanager repository
  #@ Category: Setup
  if [ ! -d "cockpit-dockermanager" ]; then
    echo "‚ùå cockpit-dockermanager directory not found"
    echo "   Run: ./run setup:clone"
    return 1
  fi

  echo "üì• Updating cockpit-dockermanager..."
  cd cockpit-dockermanager
  git pull
  cd ..
  echo "‚úÖ Upstream repository updated"
}

function setup:checkout {
  #@ Checkout specific version (usage: ./run setup:checkout <version>)
  #@ Category: Setup
  local version="${1:-}"

  if [ -z "$version" ]; then
    echo "‚ùå Please specify a version"
    echo "Usage: ./run setup:checkout <version>"
    return 1
  fi

  if [ ! -d "cockpit-dockermanager" ]; then
    echo "‚ùå cockpit-dockermanager directory not found"
    echo "   Run: ./run setup:clone"
    return 1
  fi

  echo "üîÑ Checking out version $version..."
  cd cockpit-dockermanager
  git fetch --tags
  git checkout "$version"
  cd ..
  echo "‚úÖ Checked out version $version"
}

################################################################################
# Package Management Commands

function package:deb {
  #@ Build Debian package
  #@ Category: Package Management

  if [ ! -d "cockpit-dockermanager" ]; then
    echo "‚ùå cockpit-dockermanager directory not found"
    echo "   Run: ./run setup:clone first"
    return 1
  fi

  echo "üèóÔ∏è Building Debian package..."
  package:deb:only
}

function package:deb:only {
  #@ Build Debian package from existing artifacts (internal)
  #@ Category: Package Management
  echo "üì¶ Creating Debian package..."

  export DEBEMAIL="matti.airas@hatlabs.fi"
  export DEBFULLNAME="Hat Labs CI"
  export PACKAGE_VERSION=$(release:version)

  # Create a new changelog entry
  dch --newversion "$PACKAGE_VERSION-1" \
      --distribution trixie \
      --force-distribution \
      "Automated release $PACKAGE_VERSION. See GitHub for details."

  dpkg-buildpackage -us -uc -b

  # Move the .deb file from parent directory into build directory
  mv ../*.deb . 2>/dev/null || true

  echo "‚úÖ Debian package built successfully"
}

function package:deb:only:ci {
  #@ Build Debian package for CI (bypasses environment setup)
  #@ Category: Package Management
  echo "üì¶ Creating Debian package (CI mode)..."

  export DEBEMAIL="matti.airas@hatlabs.fi"
  export DEBFULLNAME="Hat Labs CI"
  export PACKAGE_VERSION=$(release:version)

  # CI mode: Use existing changelog entry
  echo "üìã Using existing debian/changelog entry for version $PACKAGE_VERSION"

  dpkg-buildpackage -us -uc -b

  # Move the .deb file from parent directory into build directory
  mv ../*.deb . 2>/dev/null || true

  echo "‚úÖ Debian package built successfully (CI mode)"
}

function package:deb:docker {
  #@ Build Debian package using Docker container
  #@ Category: Package Management

  if [ ! -d "cockpit-dockermanager" ]; then
    echo "‚ùå cockpit-dockermanager directory not found"
    echo "   Run: ./run setup:clone first"
    return 1
  fi

  echo "üê≥ Building Debian package using Docker..."

  docker compose -f docker/docker-compose.debtools.yml run --rm debtools ./run package:deb:only

  echo "‚úÖ Docker-based Debian package built successfully"
}

function package:deb:docker:ci {
  #@ Build Debian package using Docker container (CI mode)
  #@ Category: Package Management
  echo "üê≥ Building Debian package using Docker (CI mode)..."

  # Run as root in CI to avoid permission issues with mounted volumes
  docker compose -f docker/docker-compose.debtools.yml run --rm --user root debtools ./run package:deb:only:ci

  echo "‚úÖ Docker-based Debian package built successfully (CI mode)"
}

function package:docker:build {
  #@ Build Docker tools image
  #@ Category: Package Management
  docker compose -f docker/docker-compose.debtools.yml build debtools "$@"
}

################################################################################
# Help System

function help {
  #@ Show this help message
  #@ Category: Core
  echo "Cockpit Docker Manager - Debian Packaging"
  echo "=========================================="
  echo ""
  echo "Available commands:"
  echo ""

  # Extract function definitions and their help comments
  awk '/^function / {
    fname = $2
    sub(/[({].*/, "", fname)
    getline
    if ($0 ~ /#@/) {
      desc = $0
      sub(/.*#@ /, "", desc)
      sub(/ *$/, "", desc)
      getline
      if ($0 ~ /#@ Category:/) {
        cat = $0
        sub(/.*Category: /, "", cat)
        sub(/ *$/, "", cat)
        if (!seen[cat]++) categories[++cat_count] = cat
        commands[cat, ++cmd_count[cat]] = fname
        descriptions[cat, cmd_count[cat]] = desc
      }
    }
  }
  END {
    for (i = 1; i <= cat_count; i++) {
      cat = categories[i]
      print "\n" cat ":"
      for (j = 1; j <= cmd_count[cat]; j++) {
        printf "  %-30s %s\n", commands[cat, j], descriptions[cat, j]
      }
    }
  }' "$0"

  echo ""
  echo "Usage: ./run <command> [arguments...]"
  echo ""
  echo "Quick start:"
  echo "  1. ./run setup:clone           # Clone upstream source"
  echo "  2. ./run package:deb:docker    # Build package in Docker"
}

################################################################################
# Commands end.

TIMEFORMAT=$'\nTask completed in %3lR'
time "${@:-help}"
